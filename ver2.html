<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Fruit Box (사과 상자) - 모바일 버전</title>
  <style>
    :root {
      --cell-size: 11.5vw;
      --gap: 3px;
      --cols: 6;
      --rows: 7;
      --primary-color: #2b6df6;
      --success-color: #10b981;
    }
    * {
      box-sizing: border-box;
      font-family: Inter, Noto Sans KR, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background: #f5f7fb;
      margin: 0;
      padding: 10px;
      overscroll-behavior: none;
    }
    .wrap {
      width: 100%;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
    }
    .panel {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(20,30,60,0.1);
      width: 100%;
    }
    .board {
      display: grid;
      grid-template-columns: repeat(var(--cols), var(--cell-size));
      grid-auto-rows: var(--cell-size);
      gap: var(--gap);
      padding: 5px;
      background: linear-gradient(180deg, #eef4ff, #fff);
      border-radius: 8px;
      position: relative;
      touch-action: none;
    }
    .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      background: linear-gradient(180deg, #fff, #f2f6ff);
      font-weight: 700;
      font-size: 4vw;
      user-select: none;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,0.04) inset;
      transition: transform 0.12s ease, background 0.2s ease;
    }
    .cell.fruit {
      background: linear-gradient(180deg, #ffe9e6, #fff1ea);
      color: #8b1d12;
    }
    .cell.orange {
      background: linear-gradient(180deg, #fff4e0, #fff9f0);
      color: #8b4a00;
    }
    .cell.selected {
      outline: 2px solid rgba(80,160,255,0.35);
      transform: scale(1.05);
    }
    .cell.touched {
      transform: scale(1.1);
    }
    .cell.removing {
      animation: pop 0.18s ease forwards;
    }
    @keyframes pop {
      to { transform: scale(0.2); opacity: 0; }
    }
    .info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .score-section {
      display: flex;
      gap: 80px;
    }
    .score {
      font-size: 3.5vw;
      font-weight: 800;
      color: var(--primary-color);
    }
    .meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .btn {
      padding: 8px 10px;
      border-radius: 6px;
      border: 0;
      background: var(--primary-color);
      color: #fff;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
      min-height: 40px;
    }
    .btn:hover {
      background: #1e5de0;
    }
    .btn.success {
      background: var(--success-color);
    }
    .btn.success:hover {
      background: #0d9f6e;
    }
    .btn:disabled {
      background: #6b7280;
      cursor: not-allowed;
    }
    .muted {
      color: #6b7280;
      font-size: 0.9rem;
    }
    .controls {
      display: flex;
      gap: 8px;
    }
    .hint {
      background: #fff7cc;
      padding: 8px;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .footer {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #374151;
    }
    .small {
      font-size: 0.9rem;
      color: #6b7280;
    }
    .difficulty-select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      background: #fff;
      font-size: 1rem;
      width: 100%;
    }
    .game-over {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: #fff;
      border-radius: 8px;
      animation: fadeIn 0.3s ease;
      padding: 10px;
      text-align: center;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fullscreen-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 6px 10px;
      background: var(--primary-color);
      color: #fff;
      border-radius: 6px;
      font-size: 0.9rem;
      cursor: pointer;
      z-index: 10;
    }
    @media (max-width: 400px) {
      :root {
        --cell-size: 13.5vw;
      }
      .cell {
        font-size: 4.5vw;
      }
      .score {
        font-size: 6vw;
      }
      .btn, .difficulty-select {
        font-size: 0.95rem;
      }
      .hint, .small, .footer {
        font-size: 0.85rem;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <button class="fullscreen-btn" id="fullscreenBtn">전체 화면</button>
    <div class="panel">
      <div style="font-weight:800;font-size:1.2rem;margin-bottom:8px">Fruit Box (사과 상자)</div>
      <div class="small" style="margin-bottom:8px">터치 또는 클릭으로 사각형을 만들고 합이 <strong>10</strong>이면 제거됩니다. 모든 칸을 지우면 클리어! 더 이상 합이 10이 안 되면 게임 오버.</div>
      <div id="board" class="board" draggable="false"></div>
    </div>

    <div class="panel info">
      <div class="score-section">
        <div>
          <div class="small">점수</div>
          <div id="score" class="score">0</div>
        </div>
        <div>
          <div class="small">최고 점수</div>
          <div id="highScore" class="score">0</div>
        </div>
      </div>
      <div class="meta">
        <div class="small">난이도</div>
        <select id="difficulty" class="difficulty-select">
          <option value="easy">쉬움 (6x7)</option>
          <option value="medium" selected>보통 (6x6)</option>
          <option value="hard">어려움 (6x5)</option>
        </select>
      </div>
      <div class="meta">
        <div class="small">규칙 요약</div>
        <div class="hint">사각형 선택 → 내부 합이 <strong>10</strong>이면 제거. 터진 과일 1개당 +1점.</div>
      </div>
      <div class="controls">
        <button id="restartBtn" class="btn success">재시작</button>
        <button id="hintBtn" class="btn">힌트 (3)</button>
      </div>
      <div class="footer">
        <div class="small">모바일: 터치로 시작 지점 터치 → 끝 지점 터치</div>
        <div class="small">데스크톱: 클릭 후 드래그</div>
        <div style="margin-top:6px" class="small">H키로 힌트 (키보드 지원 시)</div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const difficulties = {
        easy: { cols: 6, rows: 7 },
        medium: { cols: 6, rows: 6 },
        hard: { cols: 6, rows: 5 }
      };
      let config = difficulties.medium;
      const boardEl = document.getElementById('board');
      const scoreEl = document.getElementById('score');
      const highScoreEl = document.getElementById('highScore');
      const restartBtn = document.getElementById('restartBtn');
      const hintBtn = document.getElementById('hintBtn');
      const difficultyEl = document.getElementById('difficulty');
      const fullscreenBtn = document.getElementById('fullscreenBtn');

      let board = [];
      let score = 0;
      let highScore = localStorage.getItem('fruitBoxHighScore') ? parseInt(localStorage.getItem('fruitBoxHighScore'), 10) : 0;
      let selecting = false;
      let selStart = null, selEnd = null;
      let cells = [];
      let hintCount = 3;

      function playSound() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = ctx.createOscillator();
        const gainNode = ctx.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(1000, ctx.currentTime);
        gainNode.gain.setValueAtTime(0.5, ctx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        oscillator.connect(gainNode);
        gainNode.connect(ctx.destination);
        oscillator.start();
        oscillator.stop(ctx.currentTime + 0.2);
      }

      function createBoard() {
        board = Array.from({length: config.rows}, () => Array.from({length: config.cols}, () => randWeighted()));
      }

      function randWeighted() {
        const rand = Math.random();
        return rand < 0.7 ? Math.floor(Math.random() * 4) + 1 : Math.floor(Math.random() * 5) + 5;
      }

      function render() {
        document.documentElement.style.setProperty('--rows', config.rows);
        boardEl.innerHTML = '';
        cells = [];
        for(let r = 0; r < config.rows; r++) {
          for(let c = 0; c < config.cols; c++) {
            const val = board[r][c];
            const div = document.createElement('div');
            div.className = 'cell' + (val ? ' fruit' : '');
            if(val) {
              if(val >= 7) div.classList.add('orange');
              div.textContent = val;
            } else {
              div.style.visibility = 'hidden';
            }
            div.dataset.r = r;
            div.dataset.c = c;
            boardEl.appendChild(div);
            cells.push(div);
          }
        }
      }

      function updateScore() {
        scoreEl.textContent = score;
        if(score > highScore) {
          highScore = score;
          localStorage.setItem('fruitBoxHighScore', highScore);
          highScoreEl.textContent = highScore;
        }
      }

      function updateHighScore() { highScoreEl.textContent = highScore; }

      function computeSelectionSum(s, e) {
        const r1 = Math.min(s.r, e.r), r2 = Math.max(s.r, e.r);
        const c1 = Math.min(s.c, e.c), c2 = Math.max(s.c, e.c);
        let sum = 0, count = 0;
        for(let r = r1; r <= r2; r++) {
          for(let c = c1; c <= c2; c++) {
            const val = board[r][c];
            sum += val || 0;      // 값이 없으면 0으로 처리
            if(val) count++;      // 과일이 있는 칸만 개수 증가
          }
        }
        return { sum, count, r1, r2, c1, c2 };
      }

      function removeSelection(s, e) {
        const info = computeSelectionSum(s, e);
        if(info.sum !== 10 || info.count === 0) return false;
        playSound();
        for(let r = info.r1; r <= info.r2; r++) {
          for(let c = info.c1; c <= info.c2; c++) {
            if(board[r][c]) {
              board[r][c] = 0;
              cells[r * config.cols + c].classList.add('removing');
            }
          }
        }
        setTimeout(() => {
          render();
        }, 180);
        score += info.count;
        updateScore();
        return true;
      }

      restartBtn.addEventListener('click', init);

      function init() {
        createBoard();
        render();
        score = 0;
        hintCount = 3;
        updateScore();
        updateHighScore();
        hintBtn.textContent = `힌트 (${hintCount})`;
        hintBtn.disabled = false;
      }

      init();
    })();
  </script>
</body>
</html>
